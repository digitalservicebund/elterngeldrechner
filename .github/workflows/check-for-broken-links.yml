name: Check for broken links

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 7 * * 1-5" # Run every weekday at 9AM Berlin time (UTC+1/+2)

jobs:
  url-check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Find all urls within double quotes
        run: grep -rhoE --include=\*.{js,ts,jsx,tsx} '"https?://[^"'\'' >]+"' ./src | sed 's/^"\(.*\)"$/\1/' > links.txt

      - name: Write ignore list from GitHub variable
        run: echo '${{ vars.LINK_CHECK_IGNORE_DOMAINS }}' > ignore_domains.json

      - name: Print ignore reasons (for documentation)
        run: jq -r '.[] | "- \(.domain) -> \(.reason)"' ignore_domains.json

      - name: Filter links.txt using ignore list
        run: grep -vE "https?://($(jq -r '.[].domain' ignore_domains.json | sed 's/\./\\./g' | paste -sd '|' -))" links.txt > filtered_links.txt

      - name: Check url accessibility and log failures
        run: |
          exit_code=0
          failed_counter=0
          : > failed_urls.txt
          while read -r url; do
            echo "Checking: $url"
            if ! curl --range 0-1 --connect-timeout 5 --max-time 10 --silent --retry 1 --fail -L -v "$url" -o /dev/null 2>/tmp/curl_error; then
              echo "Failed: $url"
              echo "$url" >> failed_urls.txt
              exit_code=1
              failed_counter=$((failed_counter + 1))

              mkdir -p curl-logs
              log_file="curl-logs/failed-request-$(printf "%03d" "$failed_counter").log"
              {
                echo -e "URL: $url\nTimestamp: $(date)\n"
                cat /tmp/curl_error
              } > "$log_file"
            fi
          done < filtered_links.txt

          # Create a newline separated markdown list of slack formatted urls
          failed_csv=$(while read -r url; do echo "- <$url|$url>"; done < failed_urls.txt | paste -sd '\n' -)
          printf 'FAILED_URLS<<EOF\n%s\nEOF\n' "$failed_csv" >> "$GITHUB_ENV"

          exit "$exit_code"

      - name: Upload detailed logs for broken links
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failed-curl-logs
          path: curl-logs/
          retention-days: 7

      - name: Send failure to Slack
        uses: slackapi/slack-github-action@37ebaef184d7626c5f204ab8d3baff4262dd30f0
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        with:
          payload: |
            {
              "text": "Mindestens eine Anwendung, die wir referenzieren, ist nicht erreichbar. Mehr technische Informationen findet ihr <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|hier>.",
              "attachments": [
                {
                  "color": "#ff0000",
                  "blocks": [
                    {
                      "type": "context",
                      "elements": [
                        {
                          "type": "mrkdwn",
                          "text": "*Fehlgeschlagene Links:*"
                        },
                        {
                          "type": "mrkdwn",
                          "text": ${{ toJson(env.FAILED_URLS) }}
                        }
                      ]
                    }
                  ]
                }
              ]
            }
