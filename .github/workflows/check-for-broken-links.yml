name: Check for broken links

on:
  schedule:
    - cron: "0 7 * * 1-5" # Run every weekday at 9AM Berlin time (UTC+1/+2)

jobs:
  url-check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Find all urls within double quotes
        run: grep -rhoE --include=\*.{js,ts,jsx,tsx} '"https?://[^"'\'' >]+"' ./src | sed 's/^"\(.*\)"$/\1/' > links.txt

      - name: Write ignore list from GitHub variable
        run: echo '${{ vars.LINK_CHECK_IGNORE_DOMAINS }}' > ignore_domains.json

      - name: Print ignore reasons (for documentation)
        run: jq -r '.[] | "- \(.domain) -> \(.reason)"' ignore_domains.json

      - name: Filter links.txt using ignore list
        run: grep -vE "https?://($(jq -r '.[].domain' ignore_domains.json | sed 's/\./\\./g' | paste -sd '|' -))" links.txt > filtered_links.txt

      - name: Check url accessibility and log failures
        run: |
          exit_code=0
          failed_counter=0
          while read -r url; do
            echo "Checking: $url"
            if ! curl --range 0-1 --silent --retry 1 --fail -L -v "$url" -o /dev/null 2>/tmp/curl_error; then
              echo "Failed: $url"
              exit_code=1
              failed_counter=$((failed_counter + 1))

              # Create logs directory only when needed
              mkdir -p curl-logs

              # Create log file for this failed request
              log_file="curl-logs/failed-request-$(printf "%03d" $failed_counter).log"
              {
                echo -e "URL: $url\nTimestamp: $(date)\n"
                cat /tmp/curl_error
              } > "$log_file"
            fi
          done < <(cat filtered_links.txt)
          exit $exit_code

      - name: Upload detailed logs for broken links
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failed-curl-logs
          path: curl-logs/
          retention-days: 7

      - name: Send failure to Slack
        uses: digitalservicebund/notify-on-failure-gha@66c485757701f8d5dbee32f24df38d904ca693ba
        if: failure()
        with:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
